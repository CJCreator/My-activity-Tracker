<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Work Activity Tracker</title>
    <style>
        /* All CSS remains the same as the previous version */
        :root {
            --system-font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --blue-accent: #0A84FF;
            --blue-accent-hover: #0063CC;
            --green-accent: #30D158;
            --green-accent-hover: #25A344;
            --red-accent: #FF453A;
            --red-accent-hover: #D92C20;
            --grey-primary-text: #1d1d1f;
            --grey-secondary-text: #6e6e73;
            --grey-tertiary-text: #86868b;
            --grey-background-page: #F8F8FA;
            --grey-background-section: #ffffff;
            --grey-background-elevated: #F2F2F4;
            --grey-border-light: #E5E5EA;
            --grey-border-softer: #F2F2F4;
            --border-radius-standard: 12px;
            --border-radius-medium: 8px;
            --border-radius-small: 6px;
            --box-shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.05);
            --box-shadow-medium: 0 8px 24px rgba(0, 0, 0, 0.08);
            --dynamic-day-accent: var(--blue-accent);
            --transition-standard: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* NEW: Basic scrollbar styling for Webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--grey-background-page);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--grey-border-light);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--grey-secondary-text);
        }

        body {
            font-family: var(--system-font-stack);
            margin: 0;
            padding: 0;
            background-color: var(--grey-background-page);
            color: var(--grey-primary-text);
            line-height: 1.5;
            font-size: 16px;
        }

        .header {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--grey-primary-text);
            padding: 1rem 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--grey-border-light);
            box-shadow: var(--box-shadow-subtle);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 600;
        }

        /* NEW: Current User Display in Header */
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.5rem;
            font-size: 0.85em;
            color: var(--grey-secondary-text);
            flex-wrap: wrap;
            /* Allow wrapping of controls */
            gap: 0.5rem;
            /* Space between items in header controls */
        }

        .header-user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #current-user-display {
            font-weight: 600;
            color: var(--grey-primary-text);
        }

        .header-button {
            /* NEW: Common style for header action buttons */
            background: none;
            border: none;
            color: var(--blue-accent);
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            border-radius: var(--border-radius-small);
            transition: background-color var(--transition-standard), color var(--transition-standard);
            outline-offset: 2px;
            white-space: nowrap;
            /* Prevent text wrapping */
        }

        .header-button:hover {
            background-color: var(--grey-background-elevated);
            color: var(--blue-accent-hover);
        }

        .header-button:focus {
            outline: 2px solid var(--blue-accent);
        }


        .container {
            max-width: 1140px;
            margin: auto;
            background-color: transparent;
            padding: 1rem;
            border-radius: 0;
            box-shadow: none;
        }

        .main-content {
            display: flex;
            gap: 1.5rem;
        }

        .left-column {
            flex: 0 0 340px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .daily-log-column {
            flex-grow: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .content-section {
            background-color: var(--grey-background-section);
            padding: 1.25rem;
            border-radius: var(--border-radius-standard);
            border: 1px solid var(--grey-border-light);
            box-shadow: var(--box-shadow-subtle);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .content-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-medium);
        }

        .content-section h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--dynamic-day-accent);
            font-size: 1.25em;
            font-weight: 600;
            padding-bottom: 0.6rem;
            border-bottom: 1px solid var(--grey-border-softer);
        }

        .content-section h4 {
            font-size: 0.95em;
            font-weight: 600;
            color: var(--grey-secondary-text);
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--grey-border-softer);
        }

        .settings-section div:not(.data-management-actions) {
            margin-bottom: 0.75rem;
        }

        .settings-section label {
            display: block;
            font-size: 0.85em;
            font-weight: 500;
            color: var(--grey-secondary-text);
            margin-bottom: 0.25rem;
        }

        .settings-section input[type="number"] {
            width: calc(100% - 1.5rem);
        }

        .settings-button {
            display: block;
            width: 100%;
            padding: 0.6rem;
            font-size: 0.9em;
            font-weight: 500;
            border: none;
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            transition: background-color 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
            margin-top: 0.5rem;
            outline-offset: 2px;
        }

        .settings-button:hover {
            filter: brightness(0.95);
            transform: translateY(-1px);
        }

        .settings-button:active {
            transform: translateY(0);
            filter: brightness(0.9);
        }

        .settings-button:focus {
            outline: 2px solid var(--blue-accent);
            outline-offset: 2px;
        }

        #save-settings-btn {
            color: white;
            background-color: var(--blue-accent);
        }

        #save-settings-btn:hover {
            background-color: var(--blue-accent-hover);
        }

        #export-data-btn {
            color: white;
            background-color: var(--green-accent);
        }

        #export-data-btn:hover {
            background-color: var(--green-accent-hover);
        }

        /* NEW: Reset Password Button style (similar to Export) */
        #reset-password-btn {
            color: white;
            background-color: #AF52DE;
            /* Purple-ish color */
        }

        #reset-password-btn:hover {
            background-color: #8C40B8;
            /* Darker purple */
        }


        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .date-control {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .date-control label {
            font-weight: 500;
            margin-right: 0.5rem;
            color: var(--grey-secondary-text);
            font-size: 0.9em;
            white-space: nowrap;
        }

        .controls input[type="date"] {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--grey-border-light);
            border-radius: var(--border-radius-medium);
            font-size: 0.9em;
            background-color: var(--grey-background-section);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            outline: none;
        }

        .controls input[type="date"]:focus {
            border-color: var(--blue-accent);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);
        }

        #go-to-today-button {
            padding: 0.5rem 0.8rem;
            background-color: var(--grey-background-elevated);
            color: var(--grey-primary-text);
            border: 1px solid var(--grey-border-light);
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 500;
            transition: background-color 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
            white-space: nowrap;
            outline-offset: 2px;
        }

        #go-to-today-button:hover {
            background-color: var(--grey-border-light);
            transform: translateY(-1px);
            box-shadow: var(--box-shadow-subtle);
        }

        #go-to-today-button:active {
            transform: translateY(0);
        }

        #go-to-today-button:focus {
            outline: 2px solid var(--blue-accent);
            outline-offset: 2px;
        }

        #clear-day-button {
            padding: 0.5rem 1rem;
            background-color: var(--red-accent);
            color: white;
            border: none;
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: background-color 0.15s ease-in-out, transform 0.1s ease;
            outline-offset: 2px;
        }

        #clear-day-button:hover {
            background-color: var(--red-accent-hover);
            transform: translateY(-1px);
        }

        #clear-day-button:active {
            transform: translateY(0);
        }

        #clear-day-button:focus {
            outline: 2px solid var(--blue-accent);
            outline-offset: 2px;
        }

        .global-pending-section ul,
        .dismissed-tasks-section ul,
        .weekly-summary-section ul,
        .recurring-tasks-section ul {
            /* NEW: Add recurring-tasks-section */
            list-style-type: none;
            padding-left: 0;
            margin-top: 0.75rem;
            margin-bottom: 0;
        }

        .global-pending-section li,
        .dismissed-tasks-section li,
        .recurring-tasks-section li {
            /* NEW: Add recurring-tasks-section */
            padding: 0.75rem;
            font-size: 0.9em;
            border: 1px solid transparent;
            border-bottom: 1px solid var(--grey-border-softer);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            border-radius: var(--border-radius-medium);
            margin-bottom: 0.5rem;
            background-color: var(--grey-background-section);
            transition: background-color 0.2s ease, border-left-color 0.2s ease;
            box-shadow: var(--box-shadow-subtle);
        }

        .global-pending-section li:hover,
        .dismissed-tasks-section li:hover,
        .recurring-tasks-section li:hover {
            /* NEW: Add recurring-tasks-section */
            background-color: var(--grey-background-elevated);
        }

        /* NEW: Remove bottom border for last-child as it's redundant with individual item borders */
        .global-pending-section li:last-child,
        .dismissed-tasks-section li:last-child,
        .recurring-tasks-section li:last-child {
            /* NEW: Add recurring-tasks-section */
            border-bottom: none;
        }

        .task-info {
            flex-grow: 1;
        }

        .task-description {
            font-weight: 500;
            display: block;
            margin-bottom: 0.2rem;
            font-size: 0.95em;
        }

        .task-details {
            color: var(--grey-secondary-text);
            font-size: 0.8em;
            display: block;
        }

        .recurring-task-details {
            /* NEW: Specific style for recurring task details */
            color: var(--grey-tertiary-text);
            font-size: 0.75em;
            display: block;
            margin-top: 0.2em;
        }


        .pending-task-actions button,
        .dismissed-task-actions button,
        .recurring-task-actions button {
            /* NEW: Add recurring-task-actions */
            padding: 0.4rem 0.8rem;
            font-size: 0.8em;
            font-weight: 500;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            margin-left: 0.4rem;
            white-space: nowrap;
            transition: background-color 0.15s ease-in-out, transform 0.1s ease, filter 0.15s ease;
            color: white;
            outline-offset: 2px;
        }

        .pending-task-actions button:hover,
        .dismissed-task-actions button:hover,
        .recurring-task-actions button:hover {
            /* NEW: Add recurring-task-actions */
            filter: brightness(0.95);
            transform: translateY(-1px);
        }

        .pending-task-actions button:active,
        .dismissed-task-actions button:active,
        .recurring-task-actions button:active {
            /* NEW: Add recurring-task-actions */
            transform: translateY(0);
            filter: brightness(0.9);
        }

        .pending-task-actions button:focus,
        .dismissed-task-actions button:focus,
        .recurring-task-actions button:focus {
            /* NEW: Add recurring-task-actions */
            outline: 2px solid var(--blue-accent);
            outline-offset: 2px;
        }

        .carry-over-btn {
            background-color: var(--blue-accent);
        }

        .dismiss-pending-btn {
            background-color: var(--grey-secondary-text);
        }

        .undismiss-btn {
            background-color: var(--green-accent);
        }

        .edit-template-btn {
            /* NEW: Style for edit template button */
            background-color: #AF52DE;
        }

        .delete-template-btn {
            /* NEW: Style for delete template button */
            background-color: var(--red-accent);
        }


        .global-pending-section li.pending-aged-moderately {
            border-left: 4px solid #ffcc00;
        }

        .global-pending-section li.pending-aged-very {
            border-left: 4px solid var(--red-accent);
        }

        .daily-summary .summary-title-line,
        .weekly-summary-section .summary-title-line {
            display: flex;
            align-items: baseline;
            gap: 0.5em;
            flex-wrap: wrap;
        }

        .daily-summary #summary-day-name,
        .weekly-summary-section #weekly-summary-date-range {
            font-weight: 500;
            color: var(--grey-secondary-text);
            font-size: 1em;
        }

        .status-item-list p,
        .weekly-summary-section #weekly-summary-content p {
            display: inline-block;
            margin-right: 0.5rem;
            padding: 0.3rem 0.6rem;
            border-radius: var(--border-radius-small);
            background-color: var(--grey-background-elevated);
            color: var(--grey-secondary-text);
            font-size: 0.85em;
            font-weight: 500;
            margin-bottom: 0.3rem;
            white-space: nowrap;
        }

        .status-item-list p[data-status="Completed"],
        .weekly-summary-section p[data-status="Completed"] {
            background-color: var(--green-accent);
            color: white;
        }

        .status-item-list p[data-status="In-Progress"],
        .weekly-summary-section p[data-status="In-Progress"] {
            background-color: var(--blue-accent);
            color: white;
        }

        .status-item-list p[data-status="Blocked"],
        .weekly-summary-section p[data-status="Blocked"] {
            background-color: var(--red-accent);
            color: white;
        }

        .status-item-list p[data-status="On-Hold"],
        .weekly-summary-section p[data-status="On-Hold"] {
            background-color: #ff9500;
            color: white;
        }

        .status-item-list p[data-status="Review"],
        .weekly-summary-section p[data-status="Review"] {
            background-color: #af52de;
            color: white;
        }

        .time-slot {
            display: flex;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--grey-border-softer);
            padding-top: 0.5rem;
        }

        .time-slot:last-child {
            border-bottom: none;
        }

        .time-label {
            flex: 0 0 100px;
            font-weight: 500;
            color: var(--dynamic-day-accent);
            padding-top: 0.6rem;
            font-size: 0.9em;
        }

        .hourly-activities-container {
            flex-grow: 1;
        }

        .activity-item {
            padding: 0.25rem 0;
            margin-bottom: 0.75rem;
        }

        .activity-item-controls {
            display: flex;
            align-items: center;
            margin-bottom: 0.35rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .styled-input,
        .styled-select,
        .styled-textarea {
            padding: 0.75rem 1rem;
            border: 1.5px solid var(--grey-border-light);
            border-radius: var(--border-radius-medium);
            font-size: 0.95em;
            background-color: var(--grey-background-section);
            color: var(--grey-primary-text);
            transition: all var(--transition-standard);
            width: 100%;
            box-sizing: border-box;
            outline: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        .styled-input:hover,
        .styled-select:hover,
        .styled-textarea:hover {
            border-color: var(--grey-secondary-text);
            background-color: var(--grey-background-elevated);
        }

        .styled-input:focus,
        .styled-select:focus,
        .styled-textarea:focus {
            border-color: var(--blue-accent);
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1);
            background-color: var(--grey-background-section);
        }

        .activity-item input[type="text"].activity-description-input {
            flex-grow: 1;
            min-width: 150px;
        }

        .activity-item select.activity-status-select {
            min-width: 140px;
            width: auto;
        }

        .activity-item .delete-activity-btn {
            padding: 0.5rem 0.8rem;
            background-color: var(--red-accent);
            color: white;
            border: none;
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 500;
            transition: background-color 0.15s ease-in-out, transform 0.1s ease;
            margin-left: auto;
            outline-offset: 2px;
        }

        .activity-item .delete-activity-btn:hover {
            background-color: var(--red-accent-hover);
            transform: translateY(-1px);
        }

        .activity-item .delete-activity-btn:active {
            transform: translateY(0);
        }

        .activity-item .delete-activity-btn:focus {
            outline: 2px solid var(--blue-accent);
            outline-offset: 2px;
        }

        .activity-notes-input {
            min-height: 40px;
            resize: vertical;
            font-size: 0.9em;
            line-height: 1.4;
            margin-top: 0.25rem;
        }

        .add-activity-form {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--grey-border-softer);
        }

        .add-activity-form-row1 {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .add-activity-form input[type="text"].add-form-description {
            flex-grow: 1;
            min-width: 150px;
        }

        .add-activity-form select.add-form-status {
            min-width: 140px;
            width: auto;
        }

        .add-activity-form button.add-form-submit-btn {
            padding: 0.6rem 1rem;
            background-color: var(--green-accent);
            color: white;
            border: none;
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.15s ease-in-out, transform 0.1s ease;
            margin-top: 0.5rem;
            outline-offset: 2px;
        }

        .add-activity-form button.add-form-submit-btn:hover {
            background-color: var(--green-accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(48, 209, 88, 0.2);
        }

        .add-activity-form button.add-form-submit-btn:active {
            transform: translateY(0);
        }

        .add-activity-form button.add-form-submit-btn:focus {
            outline: 2px solid var(--blue-accent);
            outline-offset: 2px;
        }

        .add-form-notes {
            min-height: 40px;
            resize: vertical;
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        #toggle-dismissed-view-btn {
            display: block;
            width: 100%;
            padding: 0.6rem;
            font-size: 0.85em;
            font-weight: 500;
            color: var(--blue-accent);
            background-color: var(--grey-background-elevated);
            border: 1px solid var(--grey-border-light);
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            transition: background-color 0.15s ease, color 0.15s ease, transform 0.1s ease;
            outline-offset: 2px;
        }

        #toggle-dismissed-view-btn:hover {
            background-color: var(--grey-border-light);
            color: var(--blue-accent-hover);
            transform: translateY(-1px);
        }

        #toggle-dismissed-view-btn:active {
            transform: translateY(0);
        }

        #toggle-dismissed-view-btn:focus {
            outline: 2px solid var(--blue-accent);
            outline-offset: 2px;
        }

        .dismissed-tasks-section {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Modal Specific Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: var(--grey-background-section);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius-standard);
            box-shadow: var(--box-shadow-medium);
            width: 90%;
            max-width: 450px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        @keyframes fadeInModal {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--grey-primary-text);
            font-size: 1.3em;
            border-bottom: 1px solid var(--grey-border-softer);
            padding-bottom: 0.75rem;
        }

        .modal-content p {
            margin: 0.5rem 0 1rem 0;
            font-size: 0.95em;
        }

        .modal-content p strong {
            color: var(--grey-secondary-text);
        }

        .modal-content div {
            margin-bottom: 1rem;
        }

        .modal-content label {
            display: block;
            font-size: 0.85em;
            font-weight: 500;
            color: var(--grey-secondary-text);
            margin-bottom: 0.3rem;
        }

        .modal-content .styled-input,
        .modal-content .styled-select,
        .modal-content .styled-textarea {
            width: 100%;
        }

        .modal-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-bottom: 0;
        }

        .modal-actions button {
            width: auto;
            padding: 0.5rem 1rem;
            transition: background-color 0.15s ease, transform 0.1s ease, filter 0.15s ease;
            outline-offset: 2px;
        }

        .modal-actions button:hover {
            filter: brightness(0.95);
            transform: translateY(-1px);
        }

        .modal-actions button:active {
            transform: translateY(0);
            filter: brightness(0.9);
        }

        .modal-actions button:focus {
            outline: 2px solid var(--blue-accent);
            outline-offset: 2px;
        }

        .modal-actions .grey-button {
            background-color: var(--grey-background-elevated);
            color: var(--grey-primary-text);
            border: 1px solid var(--grey-border-light);
        }

        .modal-actions .grey-button:hover {
            background-color: var(--grey-border-light);
            color: var(--grey-primary-text);
        }

        /* NEW: Hide main content until user is "logged in" */
        body.logged-out .container {
            display: none;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .left-column {
                flex: none;
                width: 100%;
            }

            .daily-log-column {
                width: 100%;
            }

            .controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .controls input[type="date"] {
                width: 100%;
            }

            .date-control {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
            }

            .date-control label {
                margin-right: 0;
            }

            #clear-day-button {
                width: 100%;
            }

            .time-slot {
                flex-direction: column;
                gap: 0.5rem;
            }

            .time-label {
                flex: none;
                width: 100%;
                padding-top: 0;
            }

            .activity-item-controls,
            .add-activity-form-row1,
            .recurring-tasks-section .template-form-row {
                /* NEW: Add template form row */
                flex-direction: column;
                align-items: stretch;
            }

            .activity-item input[type="text"].activity-description-input,
            .activity-item select.activity-status-select,
            .add-activity-form input[type="text"].add-form-description,
            .add-activity-form select.add-form-status,
            .activity-item .delete-activity-btn,
            .add-activity-form button.add-form-submit-btn,
            .recurring-tasks-section .template-form-row>input[type="text"],
            /* NEW */
            .recurring-tasks-section .template-form-row>select,
            /* NEW */
            .recurring-tasks-section .template-form-row>button {
                /* NEW */
                width: 100%;
                margin-left: 0;
                margin-right: 0;
            }

            .activity-item .delete-activity-btn {
                margin-top: 0.5rem;
            }

            .recurring-tasks-section .recurring-task-actions {
                /* NEW: Stack template action buttons */
                flex-direction: column;
                gap: 0.5rem;
            }

            .recurring-tasks-section .recurring-task-actions button {
                /* NEW: Make stacked buttons full width */
                width: 100%;
                margin-left: 0;
            }
        }
    </style>
</head>

<body class="logged-out">
    <div class="header">
        <h1>Daily Work Activity Tracker</h1>
        <div class="header-controls">
            <div class="header-user-info">
                <span>Logged in as: <span id="current-user-display"></span></span>
            </div>
            <div class="header-actions">
                <button id="reset-password-main-btn" class="header-button">Reset Password</button>
                <button id="switch-user-btn" class="header-button">Switch User</button>
                <button id="logout-btn" class="header-button">Log Out</button>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="main-content">
            <div class="left-column">
                <div id="settings-section" class="settings-section content-section">
                    <h3>Work Hours</h3>
                    <div>
                        <label for="setting-start-hour">Start Hour (24-hour format, 0-23):</label>
                        <input type="number" id="setting-start-hour" min="0" max="23" class="styled-input">
                    </div>
                    <div>
                        <label for="setting-end-hour">End Hour (24-hour format, 0-23 for start of last slot):</label>
                        <input type="number" id="setting-end-hour" min="0" max="23" class="styled-input">
                    </div>
                    <button id="save-settings-btn" class="settings-button">Save Work Hours</button>
                    <h4>Data Management</h4>
                    <div class="data-management-actions">
                        <button id="export-data-btn" class="settings-button">Export All Data (JSON)</button>
                        <button id="reset-password-btn" class="settings-button">Reset Password</button>
                    </div>
                </div>

                <div id="recurring-tasks-section" class="recurring-tasks-section content-section">
                    <h3>Recurring Tasks & Templates</h3>
                    <div class="template-form">
                        <div class="template-form-row">
                            <input type="text" id="template-description" class="styled-input"
                                placeholder="Template description">
                            <select id="template-status" class="styled-select"></select>
                            <button id="add-template-btn" class="settings-button">Add Template</button>
                        </div>
                        <textarea id="template-notes" class="styled-textarea" placeholder="Notes (optional)"
                            rows="2"></textarea>
                        <div class="recurrence-options">
                            <label>Recurrence:</label>
                            <label><input type="radio" name="recurrence-type" value="none" checked> None</label>
                            <label><input type="radio" name="recurrence-type" value="daily"> Daily</label>
                            <label><input type="radio" name="recurrence-type" value="weekly"> Weekly</label>
                        </div>
                        <div id="weekly-recurrence-days" class="weekday-checkboxes" style="display: none;">
                            <label><input type="checkbox" name="weekly-day" value="1"> Mon</label>
                            <label><input type="checkbox" name="weekly-day" value="2"> Tue</label>
                            <label><input type="checkbox" name="weekly-day" value="3"> Wed</label>
                            <label><input type="checkbox" name="weekly-day" value="4"> Thu</label>
                            <label><input type="checkbox" name="weekly-day" value="5"> Fri</label>
                            <label><input type="checkbox" name="weekly-day" value="6"> Sat</label>
                            <label><input type="checkbox" name="weekly-day" value="0"> Sun</label>
                        </div>
                    </div>
                    <div id="template-list-container" class="template-list-container">
                        <p style="font-size:0.9em; color: var(--grey-secondary-text);">No templates added yet.</p>
                    </div>
                </div>

                <div id="global-pending-tasks-section" class="global-pending-section content-section"></div>
                <button id="toggle-dismissed-view-btn">View Dismissed Tasks</button>
                <div id="dismissed-tasks-section" class="dismissed-tasks-section content-section"
                    style="display: none;"></div>
            </div>
            <div class="daily-log-column">
                <div class="controls-wrapper content-section">
                    <div class="controls">
                        <div class="date-control">
                            <label for="date-picker">Select Date:</label>
                            <input type="date" id="date-picker">
                            <button id="go-to-today-button">Today</button>
                        </div>
                        <button id="clear-day-button">Clear Activities for Day</button>
                    </div>
                </div>
                <div id="daily-summary" class="daily-summary content-section">
                    <div class="summary-title-line">
                        <h3>Activity Summary for&nbsp;</h3>
                        <h3 id="summary-day-name"></h3>
                        <h3>,&nbsp;</h3>
                        <h3 id="summary-date"></h3>
                    </div>
                    <div id="summary-content" class="status-item-list"></div>
                </div>
                <div id="weekly-summary-section" class="weekly-summary-section content-section">
                    <div class="summary-title-line">
                        <h3>Weekly Summary:&nbsp;</h3>
                        <h3 id="weekly-summary-date-range"></h3>
                    </div>
                    <div id="weekly-summary-content" class="status-item-list"></div>
                </div>
                <div id="activity-log" class="content-section">
                    <h3>Today's Log</h3>
                    <div id="activity-log-content"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="carry-over-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Carry Over Task</h3>
            <p><strong>Task:</strong> <span id="modal-task-description-display"></span></p>
            <div>
                <label for="modal-carry-over-hour">Target Hour:</label>
                <select id="modal-carry-over-hour" class="styled-select"></select>
            </div>
            <div>
                <label for="modal-carry-over-status">Initial Status:</label>
                <select id="modal-carry-over-status" class="styled-select"></select>
            </div>
            <div>
                <label for="modal-carry-over-notes">Notes (optional):</label>
                <textarea id="modal-carry-over-notes" class="styled-textarea" rows="2"></textarea>
            </div>
            <div class="modal-actions">
                <button id="cancel-carry-over-btn" class="settings-button grey-button">Cancel</button>
                <button id="confirm-carry-over-btn" class="settings-button">Add to Day</button>
            </div>
        </div>
    </div>

    <div id="login-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Welcome!</h3>
            <p id="login-message">Please enter your username to access your daily tracker.</p>
            <div>
                <label for="username-input">Username:</label>
                <input type="text" id="username-input" class="styled-input" placeholder="e.g., Alice, Work">
            </div>
            <div id="password-input-group" style="display: none;">
                <label for="password-input">Password/PIN:</label>
                <input type="password" id="password-input" class="styled-input" placeholder="Enter a password/PIN">
            </div>
            <div class="modal-actions">
                <button id="login-button" class="settings-button">Continue</button>
            </div>
        </div>
    </div>

    <div id="reset-password-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Reset Password for <span id="reset-user-display"></span></h3>
            <p id="reset-modal-message">Enter your current password and set a new one.</p>
            <div>
                <label for="current-password-input">Current Password:</label>
                <input type="password" id="current-password-input" class="styled-input">
            </div>
            <div>
                <label for="new-password-input">New Password (min 4 chars, leave blank to remove password):</label>
                <input type="password" id="new-password-input" class="styled-input">
            </div>
            <div>
                <label for="confirm-new-password-input">Confirm New Password:</label>
                <input type="password" id="confirm-new-password-input" class="styled-input">
            </div>
            <div class="modal-actions">
                <button id="cancel-reset-password-btn" class="settings-button grey-button">Cancel</button>
                <button id="confirm-reset-password-btn" class="settings-button">Reset Password</button>
            </div>
        </div>
    </div>


    <script>
        let appStartHour = 9;
        let appEndHour = 17;

        const statusOptions = ["To Do", "In Progress", "Blocked", "On Hold", "Review", "Completed"];
        const BASE_MAIN_STORAGE_KEY = 'multiDayWorkTracker_v3';
        const BASE_ARCHIVED_TASKS_KEY = 'archivedTaskDescriptions_v1';
        const BASE_SETTINGS_KEY = 'workTrackerSettings_v1';
        const BASE_USER_AUTH_KEY = 'userAuthHashes';
        const BASE_TEMPLATES_KEY = 'activityTemplates_v1';
        const LAST_USERNAME_KEY = 'lastLoggedInUser';

        const MODERATELY_AGED_THRESHOLD = 3;
        const VERY_AGED_THRESHOLD = 7;

        const AUTO_SAVE_INTERVAL_MS = 5 * 60 * 1000; // 5 minutes in milliseconds

        const dayAccentColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e'];

        const activityLogContainer = document.getElementById('activity-log-content');
        const datePicker = document.getElementById('date-picker');
        const summaryDateDisplay = document.getElementById('summary-date');
        const summaryDayNameDisplay = document.getElementById('summary-day-name');
        const summaryContentContainer = document.getElementById('summary-content');
        const clearDayButton = document.getElementById('clear-day-button');
        const globalPendingTasksSection = document.getElementById('global-pending-tasks-section');
        const toggleDismissedViewBtn = document.getElementById('toggle-dismissed-view-btn');
        const dismissedTasksSection = document.getElementById('dismissed-tasks-section');
        const settingStartHourInput = document.getElementById('setting-start-hour');
        const settingEndHourInput = document.getElementById('setting-end-hour');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const weeklySummaryDateRangeDisplay = document.getElementById('weekly-summary-date-range');
        const weeklySummaryContent = document.getElementById('weekly-summary-content');
        const exportDataBtn = document.getElementById('export-data-btn');
        const carryOverModal = document.getElementById('carry-over-modal');
        const modalTaskDescriptionDisplay = document.getElementById('modal-task-description-display');
        const modalCarryOverHourSelect = document.getElementById('modal-carry-over-hour');
        const modalCarryOverStatusSelect = document.getElementById('modal-carry-over-status');
        const modalCarryOverNotesTextarea = document.getElementById('modal-carry-over-notes');
        const confirmCarryOverBtn = document.getElementById('confirm-carry-over-btn');
        const cancelCarryOverBtn = document.getElementById('cancel-carry-over-btn');
        const goToTodayButton = document.getElementById('go-to-today-button');

        const loginModal = document.getElementById('login-modal');
        const usernameInput = document.getElementById('username-input');
        const loginButton = document.getElementById('login-button');
        const currentUserDisplay = document.getElementById('current-user-display');
        const switchUserBtn = document.getElementById('switch-user-btn');

        const passwordInputGroup = document.getElementById('password-input-group');
        const passwordInput = document.getElementById('password-input');
        const loginMessage = document.getElementById('login-message');

        const logoutBtn = document.getElementById('logout-btn');
        const resetPasswordMainBtn = document.getElementById('reset-password-main-btn');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        const resetPasswordModal = document.getElementById('reset-password-modal');
        const resetUserDisplay = document.getElementById('reset-user-display');
        const resetModalMessage = document.getElementById('reset-modal-message');
        const currentPasswordInput = document.getElementById('current-password-input');
        const newPasswordInput = document.getElementById('new-password-input');
        const confirmNewPasswordInput = document.getElementById('confirm-new-password-input');
        const cancelResetPasswordBtn = document.getElementById('cancel-reset-password-btn');
        const confirmResetPasswordBtn = document.getElementById('confirm-reset-password-btn');

        const recurringTasksSection = document.getElementById('recurring-tasks-section');
        const templateDescriptionInput = document.getElementById('template-description');
        const templateStatusSelect = document.getElementById('template-status');
        const templateNotesTextarea = document.getElementById('template-notes');
        const addTemplateBtn = document.getElementById('add-template-btn');
        const recurrenceTypeRadios = document.querySelectorAll('input[name="recurrence-type"]');
        const weeklyRecurrenceDaysDiv = document.getElementById('weekly-recurrence-days');
        const weeklyRecurrenceCheckboxes = document.querySelectorAll('input[name="weekly-day"]');
        const templateListContainer = document.getElementById('template-list-container');


        let currentSelectedDate = '';
        let currentTaskToCarryOver = null;
        let currentUsername = '';
        let autosaveIntervalId = null;

        // NEW: Function to format 24-hour to 12-hour AM/PM
        function formatHourToAmPm(hour24) {
            const hour = parseInt(hour24);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12; // Convert 0 (00:00) to 12 for 12 AM
            return `${displayHour}:00 ${ampm}`;
        }

        function autosave() {
            if (!currentUsername) {
                console.log("Not saving: No user logged in.");
                return;
            }
            console.log("Autosaving data for user:", currentUsername);
            saveAllData(loadAllData());
            saveTemplates(loadTemplates());
            saveUserAuthHashes(loadUserAuthHashes());
            // saveSettings() is called directly below in its own function, or via autosave
            // if triggered by events that modify settings directly (e.g., changing hours).
            // For now, the explicit call inside saveSettings() ensures it is saved.
        }

        function startAutosave() {
            if (autosaveIntervalId) {
                clearInterval(autosaveIntervalId);
            }
            autosaveIntervalId = setInterval(autosave, AUTO_SAVE_INTERVAL_MS);
            console.log(`Autosave started for ${AUTO_SAVE_INTERVAL_MS / 1000} seconds interval.`);
        }

        function stopAutosave() {
            if (autosaveIntervalId) {
                clearInterval(autosaveIntervalId);
                autosaveIntervalId = null;
                console.log("Autosave stopped.");
            }
        }


        async function hashString(str) {
            if (typeof crypto === 'undefined' || !crypto.subtle) {
                console.warn("Web Crypto API is not available. Using a simple fallback for hashing (NOT secure).");
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash |= 0;
                }
                return hash.toString();
            }

            const textEncoder = new TextEncoder();
            const data = textEncoder.encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hexHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hexHash;
        }

        function loadUserAuthHashes() {
            const data = localStorage.getItem(BASE_USER_AUTH_KEY);
            try {
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error("Error parsing user auth data:", e);
                return {};
            }
        }

        function saveUserAuthHashes(authData) {
            localStorage.setItem(BASE_USER_AUTH_KEY, JSON.stringify(authData));
        }

        function getUserStorageKey(baseKey) {
            if (!currentUsername) {
                console.error("Attempted to generate storage key without currentUsername set. Returning base key as fallback.");
                // This scenario should be rare if login flow is followed, but provides a fallback.
                return baseKey; 
            }
            return `${baseKey}_${currentUsername.replace(/[^a-zA-Z0-9]/g, '_')}`;
        }

        function showLoginModal() {
            const lastUser = localStorage.getItem(LAST_USERNAME_KEY);
            if (lastUser) {
                usernameInput.value = lastUser;
                passwordInputGroup.style.display = 'block';
                loginMessage.textContent = `Welcome back, ${lastUser}! Please enter your password.`;
                passwordInput.value = '';
                loginButton.textContent = 'Login';
                loginModal.style.display = 'flex';
                setTimeout(() => {
                    loginModal.classList.add('show');
                    passwordInput.focus();
                }, 10);
            } else {
                usernameInput.value = '';
                passwordInputGroup.style.display = 'none';
                loginMessage.textContent = 'Please enter your username to access your daily tracker.';
                loginButton.textContent = 'Continue';
                loginModal.style.display = 'flex';
                setTimeout(() => {
                    loginModal.classList.add('show');
                    usernameInput.focus();
                }, 10);
            }
            document.body.classList.add('logged-out');
            stopAutosave();
        }


        function hideLoginModal() {
            loginModal.classList.remove('show');
            loginModal.addEventListener('transitionend', function handler() {
                loginModal.style.display = 'none';
                loginModal.removeEventListener('transitionend', handler);
            }, {
                once: true
            });
            document.body.classList.remove('logged-out');
            startAutosave();
        }

        async function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (username.length < 3) {
                alert("Username must be at least 3 characters long.");
                return;
            }

            const authHashes = loadUserAuthHashes();
            const existingUserHash = authHashes[username.toLowerCase()];

            if (!existingUserHash) {
                if (passwordInputGroup.style.display === 'none') {
                    passwordInputGroup.style.display = 'block';
                    passwordInput.value = '';
                    loginMessage.textContent = `Set a password for "${username}" (min 4 chars) or leave blank for no password:`;
                    loginButton.textContent = 'Set Password & Continue';
                    passwordInput.focus();
                    return;
                } else {
                    if (password.length > 0 && password.length < 4) {
                        alert("Password must be at least 4 characters long, or leave it blank if you don't want a password.");
                        return;
                    }
                    if (password.length > 0) {
                        authHashes[username.toLowerCase()] = await hashString(password);
                    } else {
                        delete authHashes[username.toLowerCase()];
                    }
                    saveUserAuthHashes(authHashes);
                }
            } else {
                if (password.length === 0) {
                    alert("Please enter your password for " + username + ".");
                    return;
                }
                const enteredPasswordHash = await hashString(password);
                if (enteredPasswordHash !== existingUserHash) {
                    alert("Incorrect password for " + username + ".");
                    return;
                }
            }

            if (currentUsername && currentUsername !== username) {
                const isConfirmed = confirm(`Are you sure you want to switch to user "${username}"? This will load their data.`);
                if (!isConfirmed) {
                    return;
                }
                autosave();
            }

            currentUsername = username;
            localStorage.setItem(LAST_USERNAME_KEY, currentUsername);
            currentUserDisplay.textContent = currentUsername;

            hideLoginModal();
            initializeAppDataForUser();
        }

        function handleLogout() {
            if (confirm("Are you sure you want to log out? Your current work will be saved.")) {
                autosave();
                currentUsername = '';
                localStorage.removeItem(LAST_USERNAME_KEY);
                showLoginModal();
                currentUserDisplay.textContent = '';
                activityLogContainer.innerHTML = '<p style="color: var(--grey-secondary-text);">Please select a date and log in to view activities.</p>';
                globalPendingTasksSection.innerHTML = '<h3>Past Pending Tasks</h3><p style="font-size:0.9em; color: var(--grey-secondary-text);">Select a date or log in to see pending tasks.</p>';
                dismissedTasksSection.innerHTML = '<h3>Dismissed Tasks</h3><p style="font-size:0.9em; color: var(--grey-secondary-text);">Log in to see dismissed tasks.</p>';
                weeklySummaryContent.innerHTML = '<p style="color: var(--grey-secondary-text);">Select a date or log in to see weekly summary.</p>';
                summaryContentContainer.innerHTML = '<p style="color: var(--grey-secondary-text);">Select a date or log in.</p>';
                summaryDayNameDisplay.textContent = "";
                summaryDateDisplay.textContent = "N/A";
                templateListContainer.innerHTML = '<p style="font-size:0.9em; color: var(--grey-tertiary-text);">Log in to manage templates.</p>'; // NEW: Updated message for templates
            }
        }

        async function showResetPasswordModal() {
            if (!currentUsername) {
                alert("Please log in first to reset a password.");
                return;
            }
            const authHashes = loadUserAuthHashes();
            const hasPassword = !!authHashes[currentUsername.toLowerCase()];

            resetUserDisplay.textContent = currentUsername;
            currentPasswordInput.value = '';
            newPasswordInput.value = '';
            confirmNewPasswordInput.value = '';

            if (hasPassword) {
                resetModalMessage.textContent = "Enter your current password and set a new one.";
                currentPasswordInput.style.display = 'block';
                currentPasswordInput.previousElementSibling.style.display = 'block';
                newPasswordInput.placeholder = "New Password (min 4 chars, leave blank to remove)";
            } else {
                resetModalMessage.textContent = "You don't have a password set. Set a new one now.";
                currentPasswordInput.style.display = 'none';
                currentPasswordInput.previousElementSibling.style.display = 'none';
                newPasswordInput.placeholder = "Set a Password (min 4 chars)";
            }

            resetPasswordModal.style.display = 'flex';
            setTimeout(() => {
                resetPasswordModal.classList.add('show');
                if (hasPassword) {
                    currentPasswordInput.focus();
                } else {
                    newPasswordInput.focus();
                }
            }, 10);
            stopAutosave();
        }

        function hideResetPasswordModal() {
            resetPasswordModal.classList.remove('show');
            resetPasswordModal.addEventListener('transitionend', function handler() {
                resetPasswordModal.style.display = 'none';
                resetPasswordModal.removeEventListener('transitionend', handler);
            }, {
                once: true
            });
            startAutosave();
        }

        async function handlePasswordReset() {
            const currentPass = currentPasswordInput.value.trim();
            const newPass = newPasswordInput.value.trim();
            const confirmNewPass = confirmNewPasswordInput.value.trim();

            const authHashes = loadUserAuthHashes();
            const storedHash = authHashes[currentUsername.toLowerCase()];

            if (storedHash) {
                if (currentPass.length === 0) {
                    alert("Please enter your current password.");
                    return;
                }
                const currentPassHash = await hashString(currentPass);
                if (currentPassHash !== storedHash) {
                    alert("Current password is incorrect.");
                    return;
                }
            } else {
                if (currentPass.length > 0) {
                    alert("You do not have a current password set. Please leave 'Current Password' field blank.");
                    return;
                }
            }

            if (newPass.length > 0 && newPass.length < 4) {
                alert("New password must be at least 4 characters long, or leave it blank if you don't want a password.");
                return;
            }
            if (newPass !== confirmNewPass) {
                alert("New password and confirm password do not match.");
                return;
            }

            if (newPass.length > 0) {
                authHashes[currentUsername.toLowerCase()] = await hashString(newPass);
                saveUserAuthHashes(authHashes);
                alert("Password successfully set for " + currentUsername + "!");
            } else {
                delete authHashes[currentUsername.toLowerCase()];
                saveUserAuthHashes(authHashes);
                alert("Password successfully removed for " + currentUsername + "!");
            }

            hideResetPasswordModal();
            initializeAppDataForUser();
        }

        usernameInput.addEventListener('input', async () => {
            const username = usernameInput.value.trim();
            if (username.length >= 3) {
                const authHashes = loadUserAuthHashes();
                const existingUserHash = authHashes[username.toLowerCase()];
                if (existingUserHash) {
                    passwordInputGroup.style.display = 'block';
                    loginMessage.textContent = `Welcome back, ${username}! Please enter your password.`;
                    loginButton.textContent = 'Login';
                    passwordInput.value = '';
                } else {
                    passwordInputGroup.style.display = 'block';
                    loginMessage.textContent = `Set a password for "${username}" (min 4 chars) or leave blank for no password:`;
                    loginButton.textContent = 'Set Password & Continue';
                    passwordInput.value = '';
                }
            } else {
                passwordInputGroup.style.display = 'none';
                loginMessage.textContent = 'Please enter your username to access your daily tracker.';
                loginButton.textContent = 'Continue';
            }
        });


        function initializeAppDataForUser() {
            loadSettings();
            populateTemplateStatusSelect();
            renderTemplates();
            const today = formatDate(new Date());
            datePicker.value = today;
            currentSelectedDate = today;
            renderTimeSlots();
            renderGlobalPendingTasks();
            renderDismissedTasksList();
            renderWeeklySummary();
        }


        function formatDate(dateInput) {
            const date = new Date(dateInput);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDaysDiff(date1, date2) {
            const oneDay = 1000 * 60 * 60 * 24;
            const diffTime = Math.abs(date1.getTime() - date2.getTime());
            return Math.floor(diffTime / oneDay);
        }

        function applyDailyTheme(dateStr) {
            let color = getComputedStyle(document.documentElement).getPropertyValue('--blue-accent').trim();
            if (dateStr) {
                try {
                    const dateObj = new Date(dateStr + "T00:00:00");
                    const dayIndex = dateObj.getDay();
                    color = dayAccentColors[dayIndex] || color;
                } catch (e) {
                    console.error("Error parsing date for theme:", dateStr, e);
                }
            }
            document.documentElement.style.setProperty('--dynamic-day-accent', color);
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem(getUserStorageKey(BASE_SETTINGS_KEY)));
            if (settings && typeof settings.startHour === 'number' && typeof settings.endHour === 'number') {
                appStartHour = settings.startHour;
                appEndHour = settings.endHour;
            } else {
                appStartHour = 9;
                appEndHour = 17;
            }
            settingStartHourInput.value = appStartHour;
            settingEndHourInput.value = appEndHour;
        }

        function saveSettings() {
            const startVal = parseInt(settingStartHourInput.value);
            const endVal = parseInt(settingEndHourInput.value);
            if (isNaN(startVal) || isNaN(endVal)) {
                alert("Start and End hours must be numbers.");
                return;
            }
            if (startVal < 0 || startVal > 23 || endVal < 0 || endVal > 23) {
                alert("Hours must be between 0 and 23."); // NEW: Clarified alert
                return;
            }
            if (startVal >= endVal) {
                alert("Start hour must be before end hour.");
                return;
            }
            appStartHour = startVal;
            appEndHour = endVal;
            localStorage.setItem(getUserStorageKey(BASE_SETTINGS_KEY), JSON.stringify({
                startHour: appStartHour,
                endHour: appEndHour
            }));
            alert("Work hours saved!"); 
            renderTimeSlots();
            autosave();
        }

        function loadAllData() {
            const data = localStorage.getItem(getUserStorageKey(BASE_MAIN_STORAGE_KEY));
            try {
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error("Error parsing localStorage data:", e);
                return {};
            }
        }

        function saveAllData(allData) {
            localStorage.setItem(getUserStorageKey(BASE_MAIN_STORAGE_KEY), JSON.stringify(allData));
        }

        function loadActivitiesForDate(dateStr) {
            const allData = loadAllData();
            return allData[dateStr] || {};
        }

        function loadArchivedTasks() {
            const data = localStorage.getItem(getUserStorageKey(BASE_ARCHIVED_TASKS_KEY));
            try {
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Error parsing archived tasks data:", e);
                return [];
            }
        }

        function saveArchivedTasks(archivedDescriptionsArray) {
            localStorage.setItem(getUserStorageKey(BASE_ARCHIVED_TASKS_KEY), JSON.stringify(archivedDescriptionsArray));
        }

        function archiveTaskDescription(description) {
            const normalizedDesc = description.toLowerCase().trim();
            let archived = loadArchivedTasks();
            if (!archived.includes(normalizedDesc)) {
                archived.push(normalizedDesc);
                saveArchivedTasks(archived);
                autosave();
            }
        }

        function unarchiveTaskDescription(description) {
            const normalizedDesc = description.toLowerCase().trim();
            let archived = loadArchivedTasks();
            const index = archived.indexOf(normalizedDesc);
            if (index > -1) {
                archived.splice(index, 1);
                saveArchivedTasks(archived);
                autosave();
            }
        }

        function getAllPendingTasks() {
            const allData = loadAllData();
            const archivedDescriptions = loadArchivedTasks();
            const latestTaskInstances = {};

            const sortedDateKeys = Object.keys(allData).sort((a, b) => new Date(a + 'T00:00:00') - new Date(b + 'T00:00:00'));

            for (const dateKey of sortedDateKeys) {
                const dailyActivities = allData[dateKey];
                const sortedHourKeys = Object.keys(dailyActivities).map(Number).sort((a, b) => a - b);
                for (const hour of sortedHourKeys) {
                    const hourlyActivityArray = dailyActivities[String(hour)];
                    if (Array.isArray(hourlyActivityArray)) {
                        hourlyActivityArray.forEach(activity => {
                            if (activity.description && activity.description.trim() !== "") {
                                const normalizedDesc = activity.description.toLowerCase().trim();
                                latestTaskInstances[normalizedDesc] = {
                                    description: activity.description,
                                    dateOfLastInstance: dateKey,
                                    dateObjOfLastInstance: new Date(dateKey + 'T00:00:00'),
                                    hourOfLastInstance: hour,
                                    lastStatus: activity.status,
                                    lastEdited: activity.lastEdited || new Date(dateKey + 'T00:00:00').toISOString()
                                };
                            }
                        });
                    }
                }
            }

            let globallyPendingTasks = Object.values(latestTaskInstances).filter(task => {
                const normalizedDesc = task.description.toLowerCase().trim();
                return task.lastStatus !== "Completed" && !archivedDescriptions.includes(normalizedDesc);
            });

            globallyPendingTasks.sort((a, b) => {
                const dateA = new Date(a.lastEdited);
                const dateB = new Date(b.lastEdited);
                if (dateA < dateB) return -1;
                if (dateA > dateB) return 1;
                return a.description.localeCompare(b.description);
            });

            return globallyPendingTasks;
        }

        function openCarryOverModal(taskDescription) {
            currentTaskToCarryOver = taskDescription;
            modalTaskDescriptionDisplay.textContent = taskDescription;
            modalCarryOverHourSelect.innerHTML = '';
            for (let hour = appStartHour; hour <= appEndHour; hour++) {
                const option = document.createElement('option');
                option.value = hour;
                option.textContent = formatHourToAmPm(hour);
                modalCarryOverHourSelect.appendChild(option);
            }
            modalCarryOverHourSelect.value = appStartHour;
            modalCarryOverStatusSelect.innerHTML = '';
            statusOptions.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                modalCarryOverStatusSelect.appendChild(option);
            });
            modalCarryOverStatusSelect.value = "To Do";
            modalCarryOverNotesTextarea.value = '';
            carryOverModal.style.display = 'flex';
            setTimeout(() => {
                carryOverModal.classList.add('show');
            }, 10);
            stopAutosave();
        }

        function closeCarryOverModal() {
            carryOverModal.classList.remove('show');
            carryOverModal.addEventListener('transitionend', function handler() {
                carryOverModal.style.display = 'none';
                carryOverModal.removeEventListener('transitionend', handler);
            }, {
                once: true
            });
            currentTaskToCarryOver = null;
            startAutosave();
        }

        function handleConfirmCarryOver() {
            if (!currentTaskToCarryOver || !currentSelectedDate) return;
            const selectedHour = parseInt(modalCarryOverHourSelect.value);
            const selectedStatus = modalCarryOverStatusSelect.value;
            const selectedNotes = modalCarryOverNotesTextarea.value.trim();
            addActivityToHour(currentSelectedDate, selectedHour, {
                description: currentTaskToCarryOver,
                status: selectedStatus,
                notes: selectedNotes
            });
            closeCarryOverModal();
        }


        function renderGlobalPendingTasks() {
            if (!currentSelectedDate || !currentUsername) {
                globalPendingTasksSection.innerHTML = '<h3>Past Pending Tasks</h3><p style="font-size:0.9em; color: var(--grey-secondary-text);">Select a date or log in to see pending tasks.</p>';
                return;
            }
            const pendingTasks = getAllPendingTasks();
            globalPendingTasksSection.innerHTML = '';

            const title = document.createElement('h3');
            title.textContent = 'Past Pending Tasks';
            globalPendingTasksSection.appendChild(title);

            if (pendingTasks.length > 0) {
                const ul = document.createElement('ul');
                const currentDisplayDateObj = new Date();
                currentDisplayDateObj.setHours(0, 0, 0, 0);

                pendingTasks.forEach(task => {
                    const li = document.createElement('li');
                    const lastEditedDateObj = new Date(task.lastEdited);
                    lastEditedDateObj.setHours(0, 0, 0, 0);
                    const taskAgeDays = getDaysDiff(currentDisplayDateObj, lastEditedDateObj);

                    if (lastEditedDateObj < currentDisplayDateObj) {
                        if (taskAgeDays >= VERY_AGED_THRESHOLD) {
                            li.classList.add('pending-aged-very');
                        } else if (taskAgeDays >= MODERATELY_AGED_THRESHOLD) {
                            li.classList.add('pending-aged-moderately');
                        }
                    }

                    const taskInfoDiv = document.createElement('div');
                    taskInfoDiv.classList.add('task-info');
                    const descSpan = document.createElement('span');
                    descSpan.classList.add('task-description');
                    descSpan.textContent = task.description;

                    const detailsSpan = document.createElement('span');
                    detailsSpan.classList.add('task-details');

                    let detailsText = `(Last Edited: ${formatDate(lastEditedDateObj)}, ${task.lastStatus})`;

                    if (taskAgeDays >= 1) {
                        detailsText += ` (${taskAgeDays} day${taskAgeDays > 1 ? 's' : ''} old)`;
                    }

                    detailsSpan.textContent = detailsText;

                    taskInfoDiv.appendChild(descSpan);
                    taskInfoDiv.appendChild(detailsSpan);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.classList.add('pending-task-actions');

                    const carryOverBtn = document.createElement('button');
                    carryOverBtn.classList.add('carry-over-btn');
                    carryOverBtn.title = `Carry over "${task.description}" to today's log.`;
                    carryOverBtn.textContent = 'Carry Over...';
                    carryOverBtn.onclick = () => {
                        openCarryOverModal(task.description);
                    };
                    actionsDiv.appendChild(carryOverBtn);

                    const dismissBtn = document.createElement('button');
                    dismissBtn.classList.add('dismiss-pending-btn');
                    dismissBtn.title = `Dismiss "${task.description}" from this pending list.`;
                    dismissBtn.textContent = 'Dismiss';
                    dismissBtn.onclick = () => {
                        if (confirm(`Are you sure you want to dismiss "${task.description}" from the pending list? (You can bring it back by adding/editing it again).`)) {
                            archiveTaskDescription(task.description);
                            renderGlobalPendingTasks();
                            if (dismissedTasksSection.style.display !== 'none') {
                                renderDismissedTasksList();
                            }
                        }
                    };
                    actionsDiv.appendChild(dismissBtn);

                    li.appendChild(taskInfoDiv);
                    li.appendChild(actionsDiv);
                    ul.appendChild(li);
                });
                globalPendingTasksSection.appendChild(ul);
            } else {
                const p = document.createElement('p');
                p.style.fontSize = "0.9em";
                p.style.color = "var(--grey-secondary-text)";
                p.textContent = "No globally pending tasks found.";
                globalPendingTasksSection.appendChild(p);
            }
            globalPendingTasksSection.style.display = 'block';
        }


        function renderDismissedTasksList() {
            if (!currentUsername) {
                dismissedTasksSection.innerHTML = '<h3>Dismissed Tasks</h3><p style="font-size:0.9em; color: var(--grey-secondary-text);">Log in to see dismissed tasks.</p>';
                return;
            }
            const archived = loadArchivedTasks();
            dismissedTasksSection.innerHTML = '<h3>Dismissed Tasks</h3>';
            const ul = document.createElement('ul');

            if (archived.length === 0) {
                const p = document.createElement('p');
                p.textContent = "No tasks have been dismissed.";
                p.style.fontSize = "0.9em";
                p.style.color = "var(--grey-secondary-text)";
                ul.appendChild(p);
            } else {
                archived.sort((a, b) => a.localeCompare(b));
                archived.forEach(desc => {
                    const li = document.createElement('li');
                    const taskInfoDiv = document.createElement('div');
                    taskInfoDiv.classList.add('task-info');
                    const descSpan = document.createElement('span');
                    descSpan.classList.add('task-description');
                    descSpan.textContent = desc;
                    taskInfoDiv.appendChild(descSpan);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.classList.add('dismissed-task-actions');

                    const unDismissBtn = document.createElement('button');
                    unDismissBtn.classList.add('undismiss-btn');
                    unDismissBtn.textContent = "Un-dismiss";
                    unDismissBtn.title = `Restore "${desc}" to the pending list if applicable.`;
                    unDismissBtn.onclick = () => {
                        unarchiveTaskDescription(desc);
                        renderDismissedTasksList();
                        renderGlobalPendingTasks();
                    };
                    actionsDiv.appendChild(unDismissBtn);

                    li.appendChild(taskInfoDiv);
                    li.appendChild(actionsDiv);
                    ul.appendChild(li);
                });
            }
            dismissedTasksSection.appendChild(ul);
        }

        function toggleDismissedTasksView() {
            if (dismissedTasksSection.style.display === 'none') {
                renderDismissedTasksList();
                dismissedTasksSection.style.display = 'block';
                toggleDismissedViewBtn.textContent = 'Hide Dismissed Tasks';
            } else {
                dismissedTasksSection.style.display = 'none';
                toggleDismissedViewBtn.textContent = 'View Dismissed Tasks';
            }
        }

        function hasStatusRegression(dateStr, taskDesc, newStatus, currentItemHour, currentItemIndexInHour) {
            const activitiesForDay = loadActivitiesForDate(dateStr);
            const normalizedTaskDesc = taskDesc.toLowerCase().trim();
            for (const hour in activitiesForDay) {
                const hourlyActivityArray = activitiesForDay[hour];
                if (Array.isArray(hourlyActivityArray)) {
                    for (let i = 0; i < hourlyActivityArray.length; i++) {
                        if (currentItemHour !== null && currentItemIndexInHour !== null &&
                            parseInt(hour) === currentItemHour && i === currentItemIndexInHour) {
                            continue;
                        }
                        const existingActivity = hourlyActivityArray[i];
                        if (existingActivity.description.toLowerCase().trim() === normalizedDesc) {
                            const existingStatus = existingActivity.status;
                            if (newStatus === "To Do" && ["In Progress", "Review", "Completed"].includes(existingStatus)) return true;
                            if (newStatus === "In Progress" && ["Review", "Completed"].includes(existingStatus)) return true;
                            if (newStatus === "Review" && existingStatus === "Completed") return true;
                        }
                    }
                }
            }
            return false;
        }

        function getWeekDateRange(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const day = date.getDay();
            const diffToMonday = date.getDate() - day + (day === 0 ? -6 : 1);

            const monday = new Date(date.setDate(diffToMonday));
            const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6));

            return {
                weekStart: formatDate(monday),
                weekEnd: formatDate(sunday)
            };
        }

        function renderWeeklySummary() {
            if (!currentSelectedDate || !currentUsername) {
                weeklySummaryDateRangeDisplay.textContent = '';
                weeklySummaryContent.innerHTML = '<p style="color: var(--grey-secondary-text);">Select a date or log in to see weekly summary.</p>';
                return;
            }

            const {
                weekStart,
                weekEnd
            } = getWeekDateRange(currentSelectedDate);
            weeklySummaryDateRangeDisplay.textContent = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;

            const weeklyStatusCounts = {};
            statusOptions.forEach(status => weeklyStatusCounts[status] = 0);
            let totalWeeklyActivities = 0;

            let currentDateIter = new Date(weekStart + 'T00:00:00');
            const endDateObj = new Date(weekEnd + 'T00:00:00');

            while (currentDateIter <= endDateObj) {
                const dateKey = formatDate(currentDateIter);
                const dailyActivities = loadActivitiesForDate(dateKey);
                for (const hour in dailyActivities) {
                    const hourlyActivityArray = dailyActivities[hour];
                    hourlyActivityArray.forEach(activity => {
                        if (activity.description && activity.description.trim() !== "") {
                            weeklyStatusCounts[activity.status]++;
                            totalWeeklyActivities++;
                        }
                    });
                }
                currentDateIter.setDate(currentDateIter.getDate() + 1);
            }

            weeklySummaryContent.innerHTML = '';
            if (totalWeeklyActivities === 0) {
                weeklySummaryContent.innerHTML = '<p style="color: var(--grey-secondary-text);">No activities logged for this week yet.</p>';
                return;
            }

            let hasContent = false;
            for (const status of statusOptions) {
                if (weeklyStatusCounts[status] > 0) {
                    const p = document.createElement('p');
                    p.setAttribute('data-status', status.replace(/\s+/g, '-'));
                    p.textContent = `${status}: ${weeklyStatusCounts[status]}`;
                    weeklySummaryContent.appendChild(p);
                    hasContent = true;
                }
            }
            if (!hasContent) {
                weeklySummaryContent.innerHTML = '<p style="color: var(--grey-secondary-text);">No activities with status this week.</p>';
            }
        }

        function exportDataAsJSON() {
            if (!currentUsername) {
                alert("Please log in to export data.");
                return;
            }
            const allData = loadAllData();
            if (Object.keys(allData).length === 0) {
                alert("No data to export for " + currentUsername + ".");
                return;
            }
            const jsonString = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonString], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
            a.download = `work_activity_tracker_data_${currentUsername}_${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("Data export initiated for " + currentUsername + "!");
        }

        function renderTimeSlots() {
            const activityLogContent = document.getElementById('activity-log-content');
            activityLogContent.innerHTML = '';

            if (!currentSelectedDate || !currentUsername) {
                const p = document.createElement('p');
                p.textContent = "Please select a date and log in to view activities.";
                p.style.color = "var(--grey-secondary-text)";
                activityLogContent.appendChild(p);
                updateDailySummary(currentSelectedDate);
                applyDailyTheme(null);
                renderGlobalPendingTasks();
                renderDismissedTasksList();
                renderWeeklySummary();
                return;
            }

            applyDailyTheme(currentSelectedDate);

            let hasActivitiesForDay = false;
            const activitiesForCurrentDate = loadActivitiesForDate(currentSelectedDate);

            for (let hour = appStartHour; hour <= appEndHour; hour++) {
                hasActivitiesForDay = true;
                const timeSlotDiv = document.createElement('div');
                timeSlotDiv.classList.add('time-slot');
                timeSlotDiv.setAttribute('data-hour', hour);
                const timeLabel = document.createElement('div');
                timeLabel.classList.add('time-label');
                timeLabel.textContent = formatHourToAmPm(hour);
                timeSlotDiv.appendChild(timeLabel);

                const hourlyActivitiesContainer = document.createElement('div');
                hourlyActivitiesContainer.classList.add('hourly-activities-container');
                const hourlyActivityArray = activitiesForCurrentDate[hour] || [];

                hourlyActivityArray.forEach((activity, index) => {
                    const activityItemDiv = document.createElement('div');
                    activityItemDiv.classList.add('activity-item');
                    const controlsDiv = document.createElement('div');
                    controlsDiv.classList.add('activity-item-controls');
                    const descriptionInput = document.createElement('input');
                    descriptionInput.type = 'text';
                    descriptionInput.classList.add('activity-description-input', 'styled-input');
                    descriptionInput.value = activity.description;
                    const statusSelect = document.createElement('select');
                    statusSelect.classList.add('activity-status-select', 'styled-select');
                    statusOptions.forEach(statusOpt => {
                        const option = document.createElement('option');
                        option.value = statusOpt;
                        option.textContent = statusOpt;
                        statusSelect.appendChild(option);
                    });
                    statusSelect.value = activity.status;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('delete-activity-btn');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = () => deleteActivityFromHour(currentSelectedDate, hour, index);
                    controlsDiv.appendChild(descriptionInput);
                    controlsDiv.appendChild(statusSelect);
                    controlsDiv.appendChild(deleteBtn);
                    activityItemDiv.appendChild(controlsDiv);
                    const notesTextarea = document.createElement('textarea');
                    notesTextarea.classList.add('activity-notes-input', 'styled-textarea');
                    notesTextarea.placeholder = 'Add notes...';
                    notesTextarea.value = activity.notes || "";
                    notesTextarea.rows = 2;

                    descriptionInput.onchange = () => updateActivityInHour(currentSelectedDate, hour, index, descriptionInput.value, statusSelect.value, notesTextarea.value);
                    statusSelect.onchange = () => updateActivityInHour(currentSelectedDate, hour, index, descriptionInput.value, statusSelect.value, notesTextarea.value);
                    notesTextarea.onchange = () => updateActivityInHour(currentSelectedDate, hour, index, descriptionInput.value, statusSelect.value, notesTextarea.value);

                    activityItemDiv.appendChild(notesTextarea);
                    hourlyActivitiesContainer.appendChild(activityItemDiv);
                });

                const addFormDiv = document.createElement('div');
                addFormDiv.classList.add('add-activity-form');
                const addFormRow1 = document.createElement('div');
                addFormRow1.classList.add('add-activity-form-row1');
                const newActivityInput = document.createElement('input');
                newActivityInput.type = 'text';
                newActivityInput.classList.add('add-form-description', 'styled-input');
                newActivityInput.placeholder = 'New activity for this hour...';
                const newStatusSelect = document.createElement('select');
                newStatusSelect.classList.add('add-form-status', 'styled-select');
                statusOptions.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    newStatusSelect.appendChild(option);
                });
                newStatusSelect.value = statusOptions[0];
                addFormRow1.appendChild(newActivityInput);
                addFormRow1.appendChild(newStatusSelect);
                addFormDiv.appendChild(addFormRow1);
                const newNotesTextarea = document.createElement('textarea');
                newNotesTextarea.classList.add('add-form-notes', 'styled-textarea');
                newNotesTextarea.placeholder = 'Notes (optional)';
                newNotesTextarea.rows = 2;
                addFormDiv.appendChild(newNotesTextarea);
                const addBtn = document.createElement('button');
                addBtn.classList.add('add-form-submit-btn');
                addBtn.textContent = 'Add Activity';
                addBtn.style.marginTop = "0.5rem";
                addBtn.onclick = () => {
                    const description = newActivityInput.value.trim();
                    const statusVal = newStatusSelect.value;
                    const notesVal = newNotesTextarea.value.trim();
                    if (description) {
                        addActivityToHour(currentSelectedDate, hour, {
                            description,
                            status: statusVal,
                            notes: notesVal
                        });
                        newActivityInput.value = '';
                        newNotesTextarea.value = '';
                        newStatusSelect.value = statusOptions[0];
                    } else {
                        alert("Please enter an activity description.");
                    }
                };
                addFormDiv.appendChild(addBtn);
                hourlyActivitiesContainer.appendChild(addFormDiv);
                timeSlotDiv.appendChild(hourlyActivitiesContainer);
                activityLogContent.appendChild(timeSlotDiv);
            }

            if (!hasActivitiesForDay && currentSelectedDate) {
                const p = document.createElement('p');
                p.textContent = "No activity slots for this day. Adjust work hours in Settings if needed.";
                p.style.color = "var(--grey-secondary-text)";
                activityLogContent.appendChild(p);
            }

            updateDailySummary(currentSelectedDate);
            renderGlobalPendingTasks();
            renderWeeklySummary();
            autoAddRecurringTasks(currentSelectedDate);
        }

        function autoAddRecurringTasks(dateStr) {
            const templates = loadTemplates();
            if (templates.length === 0) return;

            const activitiesForDate = loadActivitiesForDate(dateStr);
            const dateObj = new Date(dateStr + 'T00:00:00');
            const dayOfWeek = dateObj.getDay();

            templates.forEach(template => {
                let shouldAdd = false;
                if (template.recurrence.type === 'daily') {
                    shouldAdd = true;
                } else if (template.recurrence.type === 'weekly' && template.recurrence.days.includes(dayOfWeek)) {
                    shouldAdd = true;
                }

                if (shouldAdd) {
                    const normalizedTemplateDesc = template.description.toLowerCase().trim();
                    let alreadyExists = false;
                    for (const hour in activitiesForDate) {
                        const hourlyActivities = activitiesForDate[hour];
                        if (Array.isArray(hourlyActivities) && hourlyActivities.some(activity => activity.description.toLowerCase().trim() === normalizedTemplateDesc)) {
                            alreadyExists = true;
                            break;
                        }
                    }

                    if (!alreadyExists) {
                        let targetHour = appStartHour;
                        if (activitiesForDate[targetHour] && activitiesForDate[targetHour].length >= 5) {
                            console.warn(`Could not auto-add recurring task "${template.description}" for ${dateStr} at ${formatHourToAmPm(targetHour)} as the slot is full.`);
                            return;
                        }

                        addActivityToHour(dateStr, targetHour, {
                            description: template.description,
                            status: template.status,
                            notes: template.notes
                        });
                    }
                }
            });
        }

        function addActivityToHour(dateStr, hour, activityDetails) {
            const allData = loadAllData();
            if (!allData[dateStr]) allData[dateStr] = {};
            if (!allData[dateStr][hour] || !Array.isArray(allData[dateStr][hour])) {
                allData[dateStr][hour] = [];
            }
            const newDescLower = activityDetails.description.toLowerCase().trim();
            const existingInHour = allData[dateStr][hour];
            for (let i = 0; i < existingInHour.length; i++) {
                if (existingInHour[i].description.toLowerCase().trim() === newDescLower) {
                    alert(`The task "${activityDetails.description}" already exists in this hour for ${dateStr}.`);
                    return;
                }
            }
            if (hasStatusRegression(dateStr, activityDetails.description, activityDetails.status, null, null)) {
                alert(`Status regression for task "${activityDetails.description}". It may have a more advanced status recorded elsewhere for today.`);
            }
            unarchiveTaskDescription(activityDetails.description);
            const activityToAdd = {
                description: activityDetails.description,
                status: activityDetails.status,
                notes: activityDetails.notes || "",
                lastEdited: new Date().toISOString()
            };
            allData[dateStr][hour].push(activityToAdd);
            saveAllData(allData);
            renderTimeSlots();
            autosave();
        }

        function deleteActivityFromHour(dateStr, hour, activityIndex) {
            if (!confirm("Are you sure you want to delete this activity?")) {
                return;
            }
            const allData = loadAllData();
            if (allData[dateStr] && allData[dateStr][hour] && allData[dateStr][hour][activityIndex] !== undefined) {
                allData[dateStr][hour].splice(activityIndex, 1);
                saveAllData(allData);
                renderTimeSlots();
                autosave();
            }
        }

        function updateActivityInHour(dateStr, hour, activityIndex, newDescription, newStatus, newNotes) {
            const allData = loadAllData();
            if (!allData[dateStr] || !allData[dateStr][hour] || allData[dateStr][hour][activityIndex] === undefined) {
                console.warn("Attempted to update non-existent activity:", dateStr, hour, activityIndex);
                renderTimeSlots();
                return;
            }
            const originalDescription = allData[dateStr][hour][activityIndex].description;
            const newDescTrimmedLower = newDescription.toLowerCase().trim();
            const currentHourActivities = allData[dateStr][hour];
            for (let i = 0; i < currentHourActivities.length; i++) {
                if (i === activityIndex) continue;
                if (currentHourActivities[i].description.toLowerCase().trim() === newDescTrimmedLower) {
                    alert(`The description "${newDescription}" matches another task in this hour.`);
                    renderTimeSlots();
                    return;
                }
            }
            if (hasStatusRegression(dateStr, newDescription, newStatus, hour, activityIndex)) {
                alert(`Status regression for task "${newDescription}". It may have a more advanced status today.`);
                renderTimeSlots();
                return;
            }
            unarchiveTaskDescription(newDescription);
            if (originalDescription.toLowerCase().trim() !== newDescription.toLowerCase().trim()) {
                unarchiveTaskDescription(originalDescription);
            }
            allData[dateStr][hour][activityIndex].description = newDescription.trim();
            allData[dateStr][hour][activityIndex].status = newStatus;
            allData[dateStr][hour][activityIndex].notes = newNotes.trim();
            allData[dateStr][hour][activityIndex].lastEdited = new Date().toISOString();
            saveAllData(allData);
            updateDailySummary(dateStr);
            renderGlobalPendingTasks();
            renderWeeklySummary();
            autosave();
        }

        updateDailySummary = function (dateStr) {
            if (!dateStr || !currentUsername) {
                summaryDayNameDisplay.textContent = '';
                summaryDateDisplay.textContent = 'N/A';
                summaryContentContainer.innerHTML = '<p style="color: var(--grey-secondary-text);">Select a date or log in.</p>';
                return;
            }

            const dateObj = new Date(dateStr + 'T00:00:00');
            summaryDayNameDisplay.textContent = dateObj.toLocaleDateString(undefined, {
                weekday: 'long'
            });
            summaryDateDisplay.textContent = formatDate(dateObj);

            const activitiesForDate = loadActivitiesForDate(dateStr);
            const summaryCounts = {};
            statusOptions.forEach(status => summaryCounts[status] = 0);
            let totalActivitiesLogged = 0;
            for (const hourKey in activitiesForDate) {
                const hourlyActivityArray = activitiesForDate[hourKey];
                hourlyActivityArray.forEach(activity => {
                    if (activity && activity.status && activity.description && activity.description.trim() !== "") {
                        summaryCounts[activity.status]++;
                        totalActivitiesLogged++;
                    }
                });
            }

            summaryContentContainer.innerHTML = '';
            if (totalActivitiesLogged === 0) {
                summaryContentContainer.innerHTML = '<p style="color: var(--grey-secondary-text);">No activities logged yet.</p>';
                return;
            }

            let summaryHasContent = false;
            for (const status of statusOptions) {
                if (summaryCounts[status] > 0) {
                    const p = document.createElement('p');
                    p.setAttribute('data-status', status.replace(/\s+/g, '-'));
                    p.textContent = `${status}: ${summaryCounts[status]}`;
                    summaryContentContainer.appendChild(p);
                    summaryHasContent = true;
                }
            }
            if (!summaryHasContent) {
                summaryContentContainer.innerHTML = '<p style="color: var(--grey-secondary-text);">No activities with status.</p>';
            }
        }


        // --- Event Listeners & Initialization ---
        datePicker.addEventListener('change', (event) => {
            currentSelectedDate = event.target.value;
            renderTimeSlots();
            autosave();
        });
        clearDayButton.addEventListener('click', () => {
            if (!currentSelectedDate) {
                alert("Please select a date first.");
                return;
            }
            const dayNameToConfirm = summaryDayNameDisplay.textContent ? `${summaryDayNameDisplay.textContent}, ` : '';
            const dateToConfirm = summaryDateDisplay.textContent !== 'N/A' ? summaryDateDisplay.textContent : currentSelectedDate;
            const isConfirmed = window.confirm(`Are you sure you want to clear ALL activities for ${dayNameToConfirm}${dateToConfirm}? This cannot be undone.`);
            if (isConfirmed) {
                const allData = loadAllData();
                if (allData[currentSelectedDate]) {
                    delete allData[currentSelectedDate];
                    saveAllData(allData);
                    renderTimeSlots();
                    alert(`Activities for ${dayNameToConfirm}${dateToConfirm} have been cleared.`);
                    autosave();
                } else {
                    alert(`No activities found for ${dayNameToConfirm}${dateToConfirm} to clear.`);
                }
            }
        });

        goToTodayButton.addEventListener('click', () => {
            const today = formatDate(new Date());
            datePicker.value = today;
            currentSelectedDate = today;
            renderTimeSlots();
            autosave();
        });

        toggleDismissedViewBtn.addEventListener('click', () => {
            toggleDismissedTasksView();
            autosave();
        });
        saveSettingsBtn.addEventListener('click', saveSettings);
        exportDataBtn.addEventListener('click', exportDataAsJSON);
        confirmCarryOverBtn.addEventListener('click', handleConfirmCarryOver);
        cancelCarryOverBtn.addEventListener('click', closeCarryOverModal);
        carryOverModal.addEventListener('click', (event) => {
            if (event.target === carryOverModal) {
                closeCarryOverModal();
            }
        });

        // Login Modal Event Listeners
        loginButton.addEventListener('click', handleLogin);
        usernameInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleLogin();
            }
        });
        passwordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleLogin();
            }
        });
        switchUserBtn.addEventListener('click', () => {
            localStorage.setItem(LAST_USERNAME_KEY, currentUsername);
            showLoginModal();
        });

        // Logout and Reset Password Event Listeners
        logoutBtn.addEventListener('click', handleLogout);
        resetPasswordMainBtn.addEventListener('click', showResetPasswordModal);
        resetPasswordBtn.addEventListener('click', showResetPasswordModal);
        cancelResetPasswordBtn.addEventListener('click', hideResetPasswordModal);
        confirmResetPasswordBtn.addEventListener('click', handlePasswordReset);
        currentPasswordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') handlePasswordReset();
        });
        newPasswordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') handlePasswordReset();
        });
        confirmNewPasswordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') handlePasswordReset();
        });

        // Recurring Tasks Event Listeners
        addTemplateBtn.addEventListener('click', () => {
            addTemplate();
            autosave();
        });
        templateListContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-template-btn')) {
                const templateId = parseInt(event.target.closest('li').getAttribute('data-template-id'));
                deleteTemplate(templateId);
                autosave();
            }
            if (event.target.classList.contains('add-template-to-day-btn')) {
                const templateId = parseInt(event.target.closest('li').getAttribute('data-template-id'));
                const templates = loadTemplates();
                const template = templates.find(t => t.id === templateId);
                if (template) {
                    openCarryOverModal(template.description);
                }
            }
        });


        // Initial Load Logic
        document.addEventListener('DOMContentLoaded', () => {
            const today = formatDate(new Date());
            datePicker.value = today;
            currentSelectedDate = today;
            summaryDateDisplay.textContent = formatDate(new Date(today + 'T00:00:00'));
            summaryDayNameDisplay.textContent = new Date(today + 'T00:00:00').toLocaleDateString(undefined, {
                weekday: 'long'
            });
            summaryContentContainer.innerHTML = '<p style="color: var(--grey-secondary-text);">Select a date or log in.</p>';
            weeklySummaryContent.innerHTML = '<p style="color: var(--grey-secondary-text);">Select a date or log in to see weekly summary.</p>';
            activityLogContainer.innerHTML = '<p style="color: var(--grey-secondary-text);">Please select a date and log in to view activities.</p>';
            globalPendingTasksSection.innerHTML = '<h3>Past Pending Tasks</h3><p style="font-size:0.9em; color: var(--grey-secondary-text);">Select a date or log in to see pending tasks.</p>';
            dismissedTasksSection.innerHTML = '<h3>Dismissed Tasks</h3><p style="font-size:0.9em; color: var(--grey-secondary-text);">Log in to see dismissed tasks.</p>';
            templateListContainer.innerHTML = '<p style="font-size:0.9em; color: var(--grey-tertiary-text);">Log in to manage templates.</p>';

            const lastUser = localStorage.getItem(LAST_USERNAME_KEY);
            if (lastUser) {
                usernameInput.value = lastUser;
                usernameInput.dispatchEvent(new Event('input'));

                loginModal.style.display = 'flex';
                setTimeout(() => {
                    loginModal.classList.add('show');
                    passwordInput.focus();
                }, 10);
                document.body.classList.add('logged-out');
            } else {
                showLoginModal();
            }

            window.addEventListener('beforeunload', autosave);
        });
    </script>
</body>

</html>